---
title: "Extract data from Censu 2010 summary file 1"
author: "Vignette Author"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Extract data from Censu 2010 summary file 1 with urban/rural update}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
```{r echo=FALSE}
library(knitr)
opts_chunk$set(eval = FALSE)
```



The package `rawcensus2010` extract census data from raw Census 2010 summary file 1 (with urban/rural update), which is downloaded and saved in local computer. This viginette demonstrates how to extract data of interests thgough a few examples.

The article has two parts: 

- **Extract data from national files**: The national data (in subfolder `US/`) collects data from the US, regions, states, counties, places, and down to county subdivisions and even place/remiander. If we want summary data above place/remiander level, it will faster and complete to use national files.
- **Extract data from state files**: For each state, the file collect from state, counties, palces, down to census tract and even block level. If we want to data at or below census tract level, we will have to use the state files.


## Extract census data from national files
### Example 1: total population of white, black, and asian in each state
First we need to find the table contents for race population. 

```{r}
library(rawcensus2010)
library(data.table)
library(magrittr)
library(ggplot2)
library(dplyr)

# search for the table for race population
search_datafile("race population")
```

From the search results, we find the table contents for white, black, and asian population are "`0030002`, `P0030003`, and `P0030005` respectively. To read their population in each state, we want to keep geographic headers `STATE`, `NAME`, `SUMLEV`, and `GEOCOMP`.

```{r}
# This is the path to the census data in my computer, change to yours 
path <- "~/dropbox_datasets/US_2010_census/"  
race_popl <- read_2010census(path, "US", 
                             c("STATE", "NAME"),
                             c("P0030002", "P0030003", "P0030005")) %>%
    # rename the table contents to "white", "black", and "asian". From here the data
    # can be processed with data.table or dplyr package
    setnames(c("P0030002", "P0030003", "P0030005"), c("white", "black", "asian")) %>%
    # summary level for state is "040" and geographic component for all area is "00"
    .[SUMLEV == "040" & GEOCOMP == "00"] %>%
    # keep columns we care
    .[, .(NAME, white, black, asian)]
head(race_popl)
```

Equivalent `dplyr` code:
```{r eval}
race_popl <- read_2010census(path, "US", 
                             c("STATE", "NAME", "SUMLEV", "GEOCOMP"),
                             c("P0030002", "P0030003", "P0030005")) %>%
    rename(white = P0030002, black = P0030003, asian = P0030005) %>%
    filter(SUMLEV == "040" & GEOCOMP == "00") %>%
    select(c("NAME", "white", "black", "asian"))

```


In above codes, we can get urban populations by filtering with `GEOCOMP == "01"`, rural population with `GEOCOMP == "43"`, or population in any geographic components with corresponding GEOCOMP code. Similarly, we can get the populations in all counties by filtering with `SUMLEV == "050"`.

### Location of and number of inmates in federal and state prisons
Again the first thing is to find the table contents for federal and state prison populaiton:
```{r}
search_datafile("prison population")
```

From the return we know that table contents `PCT0200005` and `PCT0200006` are what we want. In reading census data we want to keep the geographic header `INTPTLON` and `INTPTLAT` which are the longitude and latitude of the area of prison location. We keep the resolution down to county subdivision level and filter the geographic component to all area.

```{r}
prison <- read_2010census(path, "US",
                          c("INTPTLON", "INTPTLAT"),
                          c("PCT0200005", "PCT0200006")) %>%
    setnames(c("INTPTLON", "INTPTLAT", "PCT0200005", "PCT0200006"), 
             c("lon", "lat", "federal", "state")) %>%
    # summary level of country subdivision is "060", geocomponent of all is "00"
    .[SUMLEV == "060" & GEOCOMP == "00"] %>%
    # keep columns of interests
    .[, .(lon, lat, federal, state)] %>%
    # remove the places having no prison
    .[federal != 0 | state != 0] %>%
    .[federal == 0, federal := NA] %>%
    .[state == 0, state := NA]
head(prison)
```

We can plot them on a map.
```{r}
ggplot() +
    geom_path(data = map_data("world"), aes(long, lat, group = group), color = "grey", size=0.5) +
    geom_path(data = map_data("state"), aes(long, lat, group = group), color = "grey", size=0.3) +
    geom_point(data = prison,
               aes(lon, lat, size = state, color = "blue"),
               alpha = 0.5) +
    geom_point(data = prison,
               aes(lon, lat, size = federal, color = "red"),
               alpha = 0.5) +
    scale_size_area(max_size = 4, breaks = c(1000, 5000, 10000, 20000)) +
    scale_color_identity(guide = "legend",
                         breaks = c("red", "blue"),
                         labels = c("federal", "state")) +
    guides(color = guide_legend(override.aes = list(alpha = 1, size = 4))) +
    labs(color = NULL, size = "inmates", x = NULL, y = NULL) +
    xlim(-180, -60) +
    ylim(15, 66) +
    coord_map() +
    theme(panel.grid = element_blank(),
          axis.text = element_blank(),
          axis.ticks = element_blank())
```

There is no federal prison in Alaska and Havaii but one in Purto Rico although it is not a state. A large state prison appears to the west of Havaii, which is a census data error.
